<!DOCTYPE html>
<html>
<head>
    <title>Sensors - Proyect Sobek</title>
    {%  include 'includeScripts.html' %}
    <script>

        $(function() {
            $( "#from" ).datepicker({
                dateFormat: 'yy-mm-dd',
                defaultDate: "-2w",
                maxDate: "0",
                changeMonth: true,
                numberOfMonths: 3,
                onClose: function( selectedDate ) {
                    $( "#to" ).datepicker( "option", "minDate", selectedDate );
                }
            });
            $( "#to" ).datepicker({
                dateFormat: 'yy-mm-dd',
                defaultDate: "0",
                maxDate: "0",
                changeMonth: true,
                numberOfMonths: 3,
                onClose: function( selectedDate ) {
                    $( "#from" ).datepicker( "option", "maxDate", selectedDate );
                }
            });

            getFields('field');
        });

        function getSensorsLog(){

            sensor_id = $('#sensor').val() ;
            if (sensor_id === null){
                hideTag('graphs');
                alert('No sensor has been selected');
                return;
            }
            if ( ( $('#from').val() === "") || ( $('#to').val() === "" ) ){
                alert('You must select a date Range to proceed');
                return;
            }

            $.ajax({
                url: "/Sensor_Log/",
                data: {
                    sensor_id : sensor_id,
                    min_date: $('#from').val() + ' 00:00:00',
                    max_date: $('#to').val() + ' 23:59:59',
                    ordering: "-log_timestamp"
                },
                success:function(data){
                    time_array =[];
                    hl1_array = [];
                    hl2_array = [];
                    hl3_array = [];
                    temperature_array = [];
                    //data.reverse();

                    $.each(data, function( index, value ) {

                        time_array.push(value.log_timestamp);
                        hl1_array.push(value.sensor_hl1);
                        hl2_array.push(value.sensor_hl2);
                        hl3_array.push(value.sensor_hl3);
                        temperature_array.push(value.sensor_temperature);
                    });

                    var evChart = {
                        labels : time_array,
                        datasets: [
                            {
                                fillColor : "rgba(204,0,0,0.5)",
                                strokeColor : "rgba(204,0,0,1)",
                                pointColor : "rgba(204,0,0,1)",
                                pointStrokeColor : "#fff",
                                data : hl3_array
                            },
                            {
                                fillColor : "rgba(204,204,0,0.8)",
                                strokeColor : "rgba(0,204,0,1)",
                                pointColor : "rgba(0,204,0,1)",
                                pointStrokeColor : "#fff",
                                data : hl2_array
                            },
                            {
                                fillColor : "rgba(220,220,220,0.5)",
                                strokeColor : "rgba(220,220,220,1)",
                                pointColor : "rgba(220,220,220,1)",
                                pointStrokeColor : "#fff",
                                data : hl1_array
                            }
                        ]
                    }

                    var tempChart = {
                        labels : time_array,
                        datasets: [
                            {
                                fillColor : "rgba(20,20,20,0.5)",
                                strokeColor : "rgba(20,20,20,1)",
                                pointColor : "rgba(20,20,20,1)",
                                pointStrokeColor : "#fff",
                                data : temperature_array
                            }
                        ]
                    }
                    var weather_lineChart = new Chart($("#weather_canvas").get(0).getContext("2d")).Line(evChart);
                    var weather_lineChart2 = new Chart($("#weather_canvas2").get(0).getContext("2d")).Line(tempChart);

                    showTag('graphs');
                }
            });
        }

    </script>
</head>
<body>

    {%  include 'nav.html' %}

    <section>
        <h1>Sensors</h1>
        <p>
            Select the Sensor you wish to graph:
        </p>
        <label>Field</label>
        <select id="field" onchange="getAreas('area', 'field');"></select>
        <label>Area</label>
        <select id="area" onchange="getSensors('sensor', 'area');"></select>
        <label>Sensor</label>
        <select id="sensor"></select>
        <p>Select the range of dates you wish to graph:</p>

        <label for="from">From</label>
        <input type="text" id="from" name="from">
        <label for="to">to</label>
        <input type="text" id="to" name="to">

        <button onclick="getSensorsLog();">Graph</button>
        <button onclick="hideTag('graphs');">Clean</button>

    </section>
    <section id="graphs" style="display: none;">
        <h2>Soil Moisture</h2>
        <canvas id="weather_canvas" height="250" width="1000"></canvas>
        <h2>Temperature</h2>
        <canvas id="weather_canvas2" height="250" width="1000"></canvas>

    </section>

    {%  include 'footer' %}

</body>
</html>